<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>Document</title>
 
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  
</head>
<body>
<script>
    function populate(arr){
        console.log("in populate");
        console.log(arr);
        $("#content").remove();
        var tickets = "<tbody id =\"content\">";
        $.each(arr, function(key,value){
            tickets += '<tr id = \"'+ key +'\" >';
            tickets += '<th scope="row">'+key+'</th>'
            tickets += '<td class ="route" >'+value.routeId + '</td>';
            tickets += '<td class = "fname">'+value.firstName + '</td>';
            tickets += '<td class = "lname">'+value.lastName + '</td>';
            tickets += '<td class = "seat">'+value.seat + '</td>';
            tickets += '<td class = "train">'+value.TrainId + '</td>';
            if(value.status===true){
                tickets += "<td> <button type=\"button\"  aria-label=\"Close\" id =\"c";
                tickets += key;
                tickets += "\" onClick= \" getInfo(this.id)\"";
                tickets += "> cancel </button> </td>";

            }else{
                tickets += "<td> <button data-toggle=\"modal\" data-target=\"#userInfo\" type=\"button\"  aria-label=\"Reserve\" id =\"r";
                tickets += key;
                tickets += "\" onClick= \" reserveUser(this.id)\"";
                tickets += "> Reserve </button> </td>";

            }
            tickets += "</tr>";
        });
        $('#ticket').append(tickets);
    }

    function get(){
        console.log("In get val");
        $.ajax  ({
            url : 'TicketServlet',
            data:{
                Arrival:$('#arrival').val(),
                Date: $('#date').val(),
                Departure:$('#departure').val()
            },
            type: "GET",
            success : function(res) {
                console.log("successful In get val");
                populate(res);
            }
        });
    }


    function getInfo(id){
        var len = id.length;
        var action = id.slice(0, 1);
        var row = id.slice(1, len);
        console.log(action);
        console.log(row);
        var el = "tr#"+ row;
        console.log(el);
        $(el).each(function() {
            var route = $(this).find(".route").text();
            var seat = $(this).find(".seat").text();
            var trainId = $(this).find(".train").text();
            console.log(route);
            console.log(seat);
            console.log(trainId);
            sendTicket(seat, route, trainId, row);
        });

    }

    function reserveUser(id){
        var len = id.length;
        var action = id.slice(0, 1);
        var row = id.slice(1, len);
        var el = "tr#"+ row;
        $(el).each(function() {
            var route = $(this).find(".route").text();
            var seat = $(this).find(".seat").text();
            var trainId = $(this).find(".train").text();
            console.log(route);
            console.log(seat);
            console.log(trainId);
            reserveTicket(seat, route, trainId, row);
        });
    }
    function changeTicket(s,r,t,row,fname,lname, email){
        this.row =row;
        $.ajax  ({
            url : 'Reserve',
            data:{
                Seat:s,
                Route: r,
                Train: t,
                Fname: fname,
                Lname:lname,
                Email: email
            },
            type: "POST",
            success : function(res) {
                if(res===1){
                    console.log("ICANSEE"+row);
                    console.log("res is 1");
                    $("tr#"+row).find(".fname").text(fname);
                    $("tr#"+row).find(".lname").text(lname);
                    $("tr#"+row).find("#r"+row).text("Cancel");
                    $("tr#"+row).find("#r"+row).attr("id", "c"+row);

                    $("tr#"+row).find("#c"+row).attr("onClick", "getInfo(this.id)");
                    $("tr#"+row).find("#c"+row).attr("data-toggle", "");
                    $("tr#"+row).find("#c"+row).attr("data-target", "");

                }
                console.log("successful In get val"+res);
            }
        });
    }

    function reserveTicket(s,r,t,row){
        this.row = row;
        this.s = s;
        this.r = r;
        this.t = t;
        var fname = $("#fname").val();
        var lname = $("#lname").val();
        var email = $("#email").val();
        var button = document.querySelector('#reserveTicket');
        button.addEventListener('click', function(e) {
            console.log("I've been clicked");
            changeTicket(s,r,t,row,fname,lname, email);

        })

    }


    function sendTicket(s , r ,t, row){
        this.row = row;
        var name=$("tr#"+row).find(".fname").text();
        var surname=$("tr#"+row).find(".lname").text();
        var cancel = confirm("Are you sure you want to cancel "+ name+" "+ surname+ " ticket?" );
        if (cancel == false){

        }else{
            console.log("in send ticket")
            $.ajax  ({
                url : 'TicketServlet',
                data:{
                    Seat:s,
                    Route: r,
                    Train: t
                },
                type: "POST",
                success : function(res) {
                    if(res===1){
                        console.log("ICANSEE"+row);
                        console.log("res is 1");
                        $("tr#"+row).find(".fname").text("Nobody");
                        $("tr#"+row).find(".lname").text("Nobody");
                        $("tr#"+row).find("#c"+row).text("Reserve");
                        $("tr#"+row).find("#c"+row).attr("id", "r"+row);
                        $("tr#"+row).find("#r"+row).attr("onClick", "reserveUser(this.id)");
                        $("tr#"+row).find("#r"+row).attr("data-toggle", "modal");
                        $("tr#"+row).find("#r"+row).attr("data-target", "#userInfo");

                    }
                    console.log("successful In get val"+res);
                }
            });
        }
    }

    function historyRequest(){
        console.log("In historyRequest");
        $.ajax  ({
            url : 'Reserve',
            data:{
                User: "adilet.mukashev"
            },
            type: "GET",
            success : function(res) {
                console.log("successful In get val");
                showHistory(res);
            }
        });

    }


    function showHistory(r){
        console.log("in showHistory");
        $("#historyContent").remove();
        var history = "<tbody id = \"historyContent\">";
        $.each(r, function(key,value){
            history += "<tr>"
            history += '<th scope="row">'+key+'</th>'
            history += '<td class ="seatH" >'+value.seat + '</td>';
            history += '<td class = "dep">'+value.dep + '</td>';
            history += '<td class = "ar">'+value.ar + '</td>';
            history += '<td class = "time">'+value.time + '</td>';
            history += '<td class = "train">'+value.TrainId + '</td>';
            history += "</tr>";

        });
        history += "</tbody>";
        $('#history').append(history);
    }








    //    function productsAdd() {
    //      // First check if a <tbody> tag exists, add one if not
    //      if ($("#ticket tbody").length == 0) {
    //        $("#ticket").append("<tbody></tbody>");
    //      }
    //
    //      // Append product to the table
    //      $("#ticket tbody").append(
    //        "<tr>" +
    //          "<td>Astana</td>" +
    //          "<td>nur-sultan</td>" +
    //          "<td>26</td>" +
    //        "</tr>"
    //        );
    //      $("#ticket tbody").append(
    //        "<tr>" +
    //        "<td>Semey</td>" +
    //          "<td>Semey</td>" +
    //          "<td>14</td>" +
    //          "<td> <button type=\"button\" class=\"close\" aria-label=\"Close\">cancel </button> </td>"+
    //        "</tr>"
    //        );
    //    }
    $(document).ready(function() {


//  $("#datepicker").click (function () {
//    $("#datepicker").datepicker({ dateFormat: 'yy-mm-dd' });
//  });


        $("#formButton").click(function() {
            $("#form1").toggle();
        });
        $("#reserveTicket").click(function(){

        });
        $("#showHistory").click(function(){
            historyRequest();
        });

        $("#submit").click(function() {
            $("#form1").toggle();
            console.log('deleteing');
            if ($("#ticket tbody tr").length != 0) {
                $("#ticket").find("tr:gt(0)").remove();
            }
            get();
            console.log($('#arrival').val());
            console.log($('#date').val());
        });


    });
</script>
 

  <button type="button" id="formButton">Toggle Form!</button>

    <form id="form1" >
      <b>Date</b> <input type="text"  id = "date">
      <br><br>
      <b>Departure</b><input type="text" name="departure" id = "departure">
      <br><br>
      <b>Arrival</b><input type="text" name="arrival" id = "arrival">
      <br><br>
      <b>Time</b><input type="text" name="time" id = "time">
      <br><br>
      
      
      <button type="button" id="submit">Submit</button>
    </form>

    <div class="container">
      <div class="row">
        <div class="col-sm-6">
          <h2>Tickets</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6">
          
          <table id="ticket"
                  class="table table-bordered
                         table-condensed table-striped">
            <thead class = "nohead">
              <tr>
              <th>#</th>
                <th>RouteID</th>
                <th>FirstName</th>
                <th>LastName</th>
                <th>seatNUmber</th>
                <th>TrainId</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id ="content">
            </tbody>
            
          </table>
        </div>
      </div>
    </div>
    
    <table id="history" class="table table-bordered table-condensed table-striped">
            <thead class = "nohead">
              <tr>
              <th>#</th>
                <th>Seat</th>
                <th>Departure</th>
                <th>Arrival</th>
                <th>Time</th>
                <th>TrainId</th>
              </tr>
            </thead>
            
            
          </table>
    
    
    
    <div class="modal fade" id="userInfo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Enter Passenger Info</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        
                        <input id="fname"  type="text" class="form-control" placeholder="First Name" aria-label="First Name" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                        
                        <input id = "lname" type="text" class="form-control" placeholder="Second Name" aria-label="Second Name" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                        
                        <input id = "email" type="text" class="form-control" placeholder="Email" aria-label="Email" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id = "reserveTicket" data-dismiss="modal">Reserve Ticket</button>
                </div>
              </div>
            </div>
          </div>
          
          <button class="btn btn-primary" id = "showHistory">Show History</button>
    


  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>